---
title: "muertes_limpiado"
author: "Grupo 4"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include = FALSE}

knitr::opts_chunk$set(warning = FALSE, message = FALSE)

```

# Bitácora 2

## Limpieza de la base

Se inicia descargando la base

```{r Descarga_base}

library(readxl)

muertes_cr <- read_excel("datos/muertes_en_costa_rica_2014_2021.xlsx")

```

Se dejan las edades de 15 años o más

```{r Nuevas_edades}

muertes_cr <- muertes_cr[muertes_cr$edads >= 15, ]

```

Se remueven las observaciones de años anteriores a 2014, la base de datos tiene muy pocas

```{r Nuevos_annos}

muertes_cr <- muertes_cr[muertes_cr$anodef >= 2014, ]

muertes_cr <- muertes_cr[muertes_cr$anotrab >= 2014, ]

muertes_cr <- muertes_cr[muertes_cr$anodeclara >= 2014, ]

```

Se procede a corregir los errores ortográficos de las principales variables

```{r Ortografia}

# Se pondrá todo sin tílde, para evitar errores al correr el código

muertes_cr$estcivil <- gsub("Ã³", "o", muertes_cr$estcivil)

muertes_cr$ocuparec <- gsub("Ã¡", "a", muertes_cr$ocuparec)

muertes_cr$ocuparec <- gsub("Ã©", "e", muertes_cr$ocuparec)

muertes_cr$ocuparec <- gsub("Ã", "i", muertes_cr$ocuparec)

muertes_cr$regsalud <- gsub("Ã", "i", muertes_cr$regsalud)

muertes_cr$regsalud <- gsub("i³", "o", muertes_cr$regsalud)

muertes_cr$provincia <- gsub("Ã©", "e", muertes_cr$provincia)

muertes_cr$provincia <- gsub("Ã³", "o", muertes_cr$provincia)

muertes_cr$provocu <- gsub("Ã©", "e", muertes_cr$provocu)

muertes_cr$provocu <- gsub("Ã³", "o", muertes_cr$provocu)

muertes_cr$provregis <- gsub("Ã©", "e", muertes_cr$provregis)

muertes_cr$provregis <- gsub("Ã³", "o", muertes_cr$provregis)

muertes_cr$reginec <- gsub("Ã", "i", muertes_cr$reginec)

muertes_cr$reginec <- gsub("i³", "o", muertes_cr$reginec)

muertes_cr$edadsrec <- gsub("100 y mÃ¡s", "100 - 121", muertes_cr$edadsrec)

muertes_cr$autopsia <- gsub("Ã©", "e", muertes_cr$autopsia)

muertes_cr$autopsia <- gsub("Ã", "i", muertes_cr$autopsia)

muertes_cr$asistmed <- gsub("Ã©", "e", muertes_cr$asistmed)

muertes_cr$asistmed <- gsub("Ã", "i", muertes_cr$asistmed)

muertes_cr$reginec <- gsub("Paci­fico", "Pacifico", muertes_cr$reginec)

muertes_cr$regsalud <- gsub("Paci­fico", "Pacifico", muertes_cr$regsalud)

```

Hay muchas nacionalidades en la base de datos, pero la mayoría son de Costa Rica, por lo que se juntará a las demás en un grupo llamado Extranjero

```{r Nacionalidades}

# Acá se ve que hay muchas nacionalidades
(length(unique(muertes_cr$nacionalid)))

# Se cambian todas las nacionalidades distintas de Costa Rica
muertes_cr$nacionalid <- gsub("^(?!Costa Rica$).*", "Extranjero", muertes_cr$nacionalid, perl = TRUE)

```
Debido a la baja cantidad de observaciones, en el estado civil se hará un grupo llamado "otros" para los que están en estado civil: ignorado, unión libre, menor y separado

```{r Estado_civil}

muertes_cr$estcivil <- gsub("Ignorado", "Otros", muertes_cr$estcivil)

muertes_cr$estcivil <- gsub("Union libre", "Otros", muertes_cr$estcivil)

muertes_cr$estcivil <- gsub("Separado", "Otros", muertes_cr$estcivil)

muertes_cr$estcivil <- gsub("Menor", "Otros", muertes_cr$estcivil)

```

Nuevamente, por la baja cantidad de observaciones en algunas ocupaciones, se juntarán algunos grupos, en este caso se harán 2 grupos llamados "Trabajadores activos" y "Otros", que contienen a las siguientes ocupaciones:

Trabajadores activos: "Profesionales cientificos e intelectuales", "Agricultores y trabajadores calificados agropecuarios, forestales y pesqueros", "Ocupaciones elementales", "Trabajadores de los servicios y vendedores de comercios y mercados", "Operadores de instalaciones y maquinas y ensambladores", "Tecnicos y profesionales de nivel medio", "Oficiales, operarios y artesanos de artes mecanicas y de otros oficios", "Personal de apoyo administrativo" y "Directores y gerentes"

Otros: "Pensionado", "Persona con discapacidad", "Estudiante", "Mal especificadas" y "Privado de libertad"

```{r Ocupacion}

# Grupo de Trabajadores activos

muertes_cr$ocuparec <- gsub("Profesionales cienti­ficos e intelectuales", "Trabajadores activos", muertes_cr$ocuparec)

muertes_cr$ocuparec <- gsub("Agricultores y trabajadores calificados agropecuarios, forestales y pesqueros", "Trabajadores activos", muertes_cr$ocuparec)

muertes_cr$ocuparec <- gsub("Ocupaciones elementales", "Trabajadores activos", muertes_cr$ocuparec)

muertes_cr$ocuparec <- gsub("Trabajadores de los servicios y vendedores de comercios y mercados", "Trabajadores activos", muertes_cr$ocuparec)

muertes_cr$ocuparec <- gsub("Operadores de instalaciones y maquinas y ensambladores", "Trabajadores activos", muertes_cr$ocuparec)

muertes_cr$ocuparec <- gsub("Tecnicos y profesionales de nivel medio", "Trabajadores activos", muertes_cr$ocuparec)

muertes_cr$ocuparec <- gsub("Oficiales, operarios y artesanos de artes mecanicas y de otros oficios", "Trabajadores activos", muertes_cr$ocuparec)

muertes_cr$ocuparec <- gsub("Personal de apoyo administrativo", "Trabajadores activos", muertes_cr$ocuparec)

muertes_cr$ocuparec <- gsub("Directores y gerentes", "Trabajadores activos", muertes_cr$ocuparec)

# Grupo de Otros
muertes_cr$ocuparec <- gsub("Pensionado", "Otros", muertes_cr$ocuparec)

muertes_cr$ocuparec <- gsub("Persona con discapacidad", "Otros", muertes_cr$ocuparec)

muertes_cr$ocuparec <- gsub("Estudiante", "Otros", muertes_cr$ocuparec)

muertes_cr$ocuparec <- gsub("Mal especificadas", "Otros", muertes_cr$ocuparec)

muertes_cr$ocuparec <- gsub("Privado de libertad", "Otros", muertes_cr$ocuparec)

```

## Análisis descriptivo

### Visualización de variables únicas

Para que el gráfico de los rangos etarios salga en orden, es necesario definir el orden antes

```{r Orden_rangos}

muertes_cr$edadsrec <- factor(muertes_cr$edadsrec, levels = c("15 - 19", "20 - 24", "25 - 29", "30 - 34", "35 - 39", "40 - 44", "45 - 49", "50 - 54", "55 - 59", "60 - 64", "65 - 69", "70 - 74", "75 - 79", "80 - 84", "85 - 89", "90 - 94", "95 - 99", "100 - 121"))

```


Se resumirán algunas de las variables de la base de datos con visualizaciones

```{r Visualizaciones_descriptivas}

library(ggplot2)

ggplot(muertes_cr, aes(x = anotrab)) +
    geom_histogram(binwidth = 1, fill = "blue", color = "black") +
    labs(x = "Año de trabajo", y = "Cantidad", caption = "Fuente: elaboración propia") +
    theme_minimal()

ggplot(muertes_cr, aes(x = mestrab)) +
  geom_bar(fill = "skyblue") +
  labs(x = "Meses", y = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(muertes_cr, aes(x = nacionalid)) +
  geom_bar(fill = "darkgoldenrod2") +
  labs(x = "Nacionalidad", y = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(muertes_cr, aes(x = sexo)) +
  geom_bar(fill = "coral") +
  labs(x = "Sexos", y = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(muertes_cr, aes(x = estcivil)) +
  geom_bar(fill = "purple") +
  labs(x = "Est. Civil", y = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(muertes_cr, aes(x = edads)) +
    geom_histogram(binwidth = 1, fill = "bisque3", color = "black") +
    labs(x = "Edades", y = "Cantidad", caption = "Fuente: elaboración propia") +
    theme_minimal()

ggplot(muertes_cr, aes(x = edadsrec)) +
  geom_bar(fill = "green3") +
  labs(x = "R. etarios", y = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(muertes_cr, aes(x = provincia)) +
  geom_bar(fill = "cornflowerblue") +
  labs(x = "Provincias", y = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(muertes_cr, aes(x = IU)) +
    geom_histogram(binwidth = 1, fill = "cyan", color = "black") +
    labs(x = "IU", y = "Cantidad", caption = "Fuente: elaboración propia") +
    theme_minimal()

ggplot(muertes_cr, aes(x = autopsia)) +
  geom_bar(fill = "darkolivegreen") +
  labs(x = "Autopsias", y = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(muertes_cr, aes(x = asistmed)) +
  geom_bar(fill = "darkolivegreen4") +
  labs(x = "Asistencia medica", y = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(muertes_cr, aes(x = provocu)) +
  geom_bar(fill = "darkorchid") +
  labs(x = "Provincia", y = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(muertes_cr, aes(x = diadef)) +
    geom_histogram(binwidth = 1, fill = "deeppink2", color = "black") +
    labs(x = "Día", y = "Cantidad", caption = "Fuente: elaboración propia") +
    theme_minimal()

ggplot(muertes_cr, aes(x = mesdef)) +
  geom_bar(fill = "darkgreen") +
  labs(x = "Mes", y = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(muertes_cr, aes(x = anodef)) +
    geom_histogram(binwidth = 1, fill = "deeppink3", color = "black") +
    labs(x = "Año", y = "Cantidad", caption = "Fuente: elaboración propia") +
    theme_minimal()

ggplot(muertes_cr, aes(x = ocuparec)) +
  geom_bar(fill = "aquamarine2") +
  labs(x = "Ocupación", y = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(muertes_cr, aes(x = provregis)) +
  geom_bar(fill = "chocolate1") +
  labs(x = "Provincia", y = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(muertes_cr, aes(x = diadeclara)) +
    geom_histogram(binwidth = 1, fill = "cornsilk2", color = "black") +
    labs(x = "Día", y = "Cantidad", caption = "Fuente: elaboración propia") +
    theme_minimal()

ggplot(muertes_cr, aes(x = mesdeclara)) +
  geom_bar(fill = "deepskyblue2") +
  labs(x = "Mes", y = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(muertes_cr, aes(x = anodeclara)) +
    geom_histogram(binwidth = 1, fill = "chartreuse3", color = "black") +
    labs(x = "Año", y = "Cantidad", caption = "Fuente: elaboración propia") +
    theme_minimal()

ggplot(muertes_cr, aes(x = grgruposcb)) +
    geom_histogram(binwidth = 1, fill = "darksalmon", color = "black") +
    labs(x = "Grupo muerte", y = "Cantidad", caption = "Fuente: elaboración propia") +
    theme_minimal()

ggplot(muertes_cr, aes(x = reginec)) +
  geom_bar(fill = "azure3") +
  labs(x = "Región", y = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(muertes_cr, aes(x = regsalud)) +
  geom_bar(fill = "azure3") +
  labs(x = "Región", y = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

### Visualizaciones adicionales

Se creará un DataFrame con las muertes por cada 1000 habitantes, para esto se usará la división de regiones que realiza el Ministerio de salud. Iniciamos obteniendo las variables necesarias

```{r Muertes_habitantes}

# Se obtienen las variables necesarias, iniciando por las regiones
annos <- unique(muertes_cr$anodef)

# Las muertes por cada año
lista_muertes <- list()

for (i in 1:length(annos)) {
  
  lista_muertes[[i]] <- nrow(muertes_cr[muertes_cr$anodef == annos[i], ])
  
}

lista_muertes <- unlist(lista_muertes)

# Introducimos las poblaciones de cada año según el INEC, van ordenadas de 2014 a 2021
poblacion <- c(4773130, 4832234, 4890379, 4947490, 5003402, 5058007, 5111238, 5163038)

# Ahora realizamos las muertes por cada 1000 habitantes según el año
muertes1000 <- list()

for(i in 1:length(annos)) {
  
  muertes1000[[i]] <- ((lista_muertes[i] / poblacion[i]) * 1000)
  
}

muertes1000 <- unlist(muertes1000)

```

Realizamos el DataFrame correspondiente

```{r Df_1000}

df_1000 <- data.frame(annos_def = annos, muertes = muertes1000)
df_1000

```

Finalmente representamos lo anterior con un gráfico

```{r Grafico}

library(ggplot2)

ggplot(data = df_1000, aes(x = annos_def, y = muertes)) +
  geom_line(color = "chartreuse3") +
  geom_point(color = "chartreuse4", size = 3) +
  labs(x = "Año", y = "Tasa de Muerte", caption = "Fuente: elaboración propia") +
  theme_minimal()

```

## Gráficos de covarianza, correlación e histogramas

### Relaciones entre los grupos de causa de muerte y las demás variables importantes

Primero se realizan histogramas relacionando los grupos de causa de muerte (eje x) y la densidad (eje y) de las diferentes subcategorías de las variables importantes

```{r Relaciones_histogramas}

library(ggplot2)

library(cowplot)

categorias <- length(unique(muertes_cr$nacionalid))

colores_aleatorios <- rainbow(categorias)

ggplot(muertes_cr, aes(x = grgruposcb, y = after_stat(density), fill = nacionalid)) +
  geom_histogram(position = "dodge", binwidth = 1, bins = 18, size = 0.5, color = "black") +
  facet_wrap(~nacionalid) +
  cowplot::theme_cowplot() +
  theme(legend.position = "none") +
  labs(x = "Grupos de causa de muertes", y = "Densidad", caption = "Fuente: elaboración propia") +
  scale_color_manual(values = colores_aleatorios)

categorias <- length(unique(muertes_cr$sexo))

colores_aleatorios <- rainbow(categorias)

ggplot(muertes_cr, aes(x = grgruposcb, y = after_stat(density), fill = sexo)) +
  geom_histogram(position = "dodge", binwidth = 1, bins = 18, size = 0.5, color = "black") +
  facet_wrap(~sexo) +
  cowplot::theme_cowplot() +
  theme(legend.position = "none") +
  labs(x = "Grupos de causa de muertes", y = "Densidad", caption = "Fuente: elaboración propia") +
  scale_color_manual(values = colores_aleatorios)

categorias <- length(unique(muertes_cr$estcivil))

colores_aleatorios <- rainbow(categorias)

ggplot(muertes_cr, aes(x = grgruposcb, y = after_stat(density), fill = estcivil)) +
  geom_histogram(position = "dodge", binwidth = 1, bins = 18, size = 0.5, color = "black") +
  facet_wrap(~estcivil) +
  cowplot::theme_cowplot() +
  theme(legend.position = "none") +
  labs(x = "Grupos de causa de muertes", y = "Densidad", caption = "Fuente: elaboración propia") +
  scale_color_manual(values = colores_aleatorios)

categorias <- length(unique(muertes_cr$ocuparec))

colores_aleatorios <- rainbow(categorias)

ggplot(muertes_cr, aes(x = grgruposcb, y = after_stat(density), fill = ocuparec)) +
  geom_histogram(position = "dodge", binwidth = 1, bins = 18, size = 0.5, color = "black") +
  facet_wrap(~ocuparec) +
  cowplot::theme_cowplot() +
  theme(legend.position = "none") +
  labs(x = "Grupos de causa de muertes", y = "Densidad", caption = "Fuente: elaboración propia") +
  scale_color_manual(values = colores_aleatorios)

categorias <- length(unique(muertes_cr$regsalud))

colores_aleatorios <- rainbow(categorias)

ggplot(muertes_cr, aes(x = grgruposcb, y = after_stat(density), fill = regsalud)) +
  geom_histogram(position = "dodge", binwidth = 1, bins = 18, size = 0.5, color = "black") +
  facet_wrap(~regsalud) +
  cowplot::theme_cowplot() +
  theme(legend.position = "none") +
  labs(x = "Grupos de causa de muertes", y = "Densidad", caption = "Fuente: elaboración propia") +
  scale_color_manual(values = colores_aleatorios)

```

Ahora se realizan gráficos de mapa de calor para seguir visualizando las relaciones entre los grupos de causa de muerte y las demás variables importantes

```{r Relaciones_mosaicos}

library(ggplot2)

library(dplyr)

muertes_cr |> 
  count(grgruposcb, nacionalid) |>  
  ggplot(aes(x = grgruposcb, y = nacionalid)) +
  geom_tile(aes(fill = n)) +
  labs(x ="Grupos de causa de muerte", y = "Nacionalidades", fill = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal()

muertes_cr |> 
  count(grgruposcb, sexo) |>  
  ggplot(aes(x = grgruposcb, y = sexo)) +
  geom_tile(aes(fill = n)) +
  labs(x ="Grupos de causa de muerte", y = "Sexos", fill = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal()

muertes_cr |> 
  count(grgruposcb, estcivil) |>  
  ggplot(aes(x = grgruposcb, y = estcivil)) +
  geom_tile(aes(fill = n)) +
  labs(x ="Grupos de causa de muerte", y = "Estados civiles", fill = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal()

muertes_cr |> 
  count(grgruposcb, ocuparec) |>  
  ggplot(aes(x = grgruposcb, y = ocuparec)) +
  geom_tile(aes(fill = n)) +
  labs(x ="Grupos de causa de muerte", y = "Ocupaciones", fill = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal()

muertes_cr |> 
  count(grgruposcb, regsalud) |>  
  ggplot(aes(x = grgruposcb, y = regsalud)) +
  geom_tile(aes(fill = n)) +
  labs(x ="Grupos de causa de muerte", y = "Regiones del Ministerio de Salud", fill = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal()

```

Sumado a lo anterior, se calculará la correlación de Spearman entre la variable asociada con los grupos de causa de muerte y las demás variables importantes, con el fin de realizar un gráfico de barras que represente dicha correlación para cada una de las variables importantes

```{r Correlaciones}

library(ggplot2)

# Correlación entre los grupos de causa de muerte y la nacionalidad

variable_importante <- as.numeric(as.factor(muertes_cr$nacionalid))

cor_spearman <- cor(muertes_cr$grgruposcb, variable_importante, method = "spearman")

vector_correlaciones <- c(cor_spearman)

# Correlación entre los grupos de causa de muerte y el sexo

variable_importante <- as.numeric(as.factor(muertes_cr$sexo))

cor_spearman <- cor(muertes_cr$grgruposcb, variable_importante, method = "spearman")

vector_correlaciones <- c(vector_correlaciones, cor_spearman)

# Correlación entre los grupos de causa de muerte y el estado civil

variable_importante <- as.numeric(as.factor(muertes_cr$estcivil))

cor_spearman <- cor(muertes_cr$grgruposcb, variable_importante, method = "spearman")

vector_correlaciones <- c(vector_correlaciones, cor_spearman)

# Correlación entre los grupos de causa de muerte y la ocupación

variable_importante <- as.numeric(as.factor(muertes_cr$ocuparec))

cor_spearman <- cor(muertes_cr$grgruposcb, variable_importante, method = "spearman")

vector_correlaciones <- c(vector_correlaciones, cor_spearman)

# Correlación entre los grupos de causa de muerte y la región del Ministerio de Salud

variable_importante <- as.numeric(as.factor(muertes_cr$regsalud))

cor_spearman <- cor(muertes_cr$grgruposcb, variable_importante, method = "spearman")

vector_correlaciones <- c(vector_correlaciones, cor_spearman)

df <- data.frame(
  
  variables_importantes = c("Nacionalidad", "Sexo", "Estado civil", "Ocupación", "Región del Ministerio \nde Salud"),
  
  correlaciones_spearman = vector_correlaciones
  
)

# Se crea el gráfico de barras entre las variables categóricas importantes y la correlación de Spearman entre ellas y la variable de grupos de causa de muerte

ggplot(df, aes(x = variables_importantes, y = correlaciones_spearman)) +
  geom_bar(stat = "identity", fill = "skyblue", size = 0.5, color = 'black') +
  labs(x = "Variable", y = "Correlación de Spearman", caption = "Fuente: elaboración propia") +
  theme_minimal()

```

### Relaciones entre diferentes variables importantes

Seguidamente, se realizarán gráficos de mapa de calor entre las variables importantes, excluyendo el grupo de causa de muerte, para visualizar si hay alguna relación entre ellas

```{r Relaciones_adicionales_mosaicos}

library(ggplot2)

library(dplyr)

# Relaciones entre la nacionalidad y las demás variables

muertes_cr |> 
  count(nacionalid, sexo) |>  
  ggplot(aes(x = nacionalid, y = sexo)) +
  geom_tile(aes(fill = n)) +
  labs(x ="Nacionalidades", y = "Sexos", fill = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal()

muertes_cr |> 
  count(nacionalid, estcivil) |>  
  ggplot(aes(x = nacionalid, y = estcivil)) +
  geom_tile(aes(fill = n)) +
  labs(x ="Nacionalidades", y = "Estados civiles", fill = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal()

muertes_cr |> 
  count(nacionalid, ocuparec) |>  
  ggplot(aes(x = nacionalid, y = ocuparec)) +
  geom_tile(aes(fill = n)) +
  labs(x ="Nacionalidades", y = "Ocupaciones", fill = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal()

muertes_cr |> 
  count(nacionalid, regsalud) |>  
  ggplot(aes(x = nacionalid, y = regsalud)) +
  geom_tile(aes(fill = n)) +
  labs(x ="Nacionalidades", y = "Regiones del Ministerio de Salud", fill = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal()

# Relaciones entre el sexo y las demás variables

muertes_cr |> 
  count(sexo, estcivil) |>  
  ggplot(aes(x = sexo, y = estcivil)) +
  geom_tile(aes(fill = n)) +
  labs(x ="Sexos", y = "Estados Civiles", fill = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal()

muertes_cr |> 
  count(sexo, ocuparec) |>  
  ggplot(aes(x = sexo, y = ocuparec)) +
  geom_tile(aes(fill = n)) +
  labs(x ="Sexos", y = "Ocupaciones", fill = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal()

muertes_cr |> 
  count(sexo, regsalud) |>  
  ggplot(aes(x = sexo, y = regsalud)) +
  geom_tile(aes(fill = n)) +
  labs(x ="Sexos", y = "Regiones del Ministerio de Salud", fill = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal()

# Relaciones entre el estado civil y las demás variables

muertes_cr |> 
  count(estcivil, ocuparec) |>  
  ggplot(aes(x = estcivil, y = ocuparec)) +
  geom_tile(aes(fill = n)) +
  labs(x ="Estados civiles", y = "Ocupaciones", fill = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal()

muertes_cr |> 
  count(estcivil, regsalud) |>  
  ggplot(aes(x = estcivil, y = regsalud)) +
  geom_tile(aes(fill = n)) +
  labs(x ="Estados civiles", y = "Regiones del Ministerio de Salud", fill = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal()

# Relaciones entre la ocupación y las demás variables

muertes_cr |> 
  count(ocuparec, regsalud) |>  
  ggplot(aes(x = ocuparec, y = regsalud)) +
  geom_tile(aes(fill = n)) +
  labs(x ="Ocupaciones", y = "Regiones del Ministerio de Salud", fill = "Frecuencia", caption = "Fuente: elaboración propia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

## Tablas de Contingencias

Se proceden a realizar cuadros que resumen la información de las variables más relevantes de la base de datos

```{r Tablas_contingencias}

library(knitr)

tabla_1 <- table(muertes_cr$grgruposcb, muertes_cr$regsalud)
kable(tabla_1, caption = "")

tabla_2 <- table(muertes_cr$grgruposcb, muertes_cr$nacionalid)
kable(tabla_2, caption = "")

tabla_3 <- table(muertes_cr$grgruposcb, muertes_cr$sexo)
kable(tabla_3, caption = "")

tabla_4 <- table(muertes_cr$grgruposcb, muertes_cr$estcivil)
kable(tabla_4, caption = "")

tabla_5 <- table(muertes_cr$grgruposcb, muertes_cr$ocuparec)
kable(tabla_5, caption = "")

tabla_1_prop <- addmargins(prop.table(tabla_1, margin = 1)*100) 
kable(tabla_1_prop, caption = "")

tabla_2_prop <- addmargins(prop.table(tabla_2, margin = 1)*100) 
kable(tabla_2_prop, caption = "")

tabla_3_prop <- addmargins(prop.table(tabla_3, margin = 1)*100) 
kable(tabla_3_prop, caption = "")

tabla_4_prop <- addmargins(prop.table(tabla_4, margin = 1)*100) 
kable(tabla_4_prop, caption = "")

tabla_5_prop <- addmargins(prop.table(tabla_5, margin = 1)*100) 
kable(tabla_5_prop, caption = "")

```

## Propuesta metodológica

### Proyecto maqueta

Se iniciará creando una tabla de ejemplo

```{r Creacion_tablas}

tabla_prueba <- as.table(rbind(
  
  c(8, 5, 3),
  c(2, 7, 11),
  c(5, 7, 6)
  
))

# Asignamos los nombres de las columnas

dimnames(tabla_prueba) <- list(
  
  Compras = c(
    
    "Arroz",
    
    "Cereal",
    
    "Bebidas"
    
  ),
  
  Voto = c("A", "B", "C")
  
)

knitr::kable(tabla_prueba)

```

Realizamos la prueba Chi-cuadrado

```{r prueba_chi-cuadrado}

chisq.test(tabla_prueba, B = 2000)

```

Se procede a explorar los parámetros de esta función

```{r Parametros}

# B son las simulaciones de Montecarlo necesarias

chisq.test(x = tabla_prueba, B = 10000)

# Con simulate.p.value, se indica si el valor p se encuentra a través de una simulación de Montecarlo (TRUE) o con la chi-cuadrado (FALSE) que usa por defecto

chisq.test(x = tabla_prueba, simulate.p.value = TRUE, B = 10000)

chisq.test(x = tabla_prueba, simulate.p.value = TRUE, B = 2000)

# Correct aplica una corrección de continuidad en el cálculo de la Chi-cuadrado (TRUE), de lo contrario no la aplica (False)

chisq.test(x = tabla_prueba, correct = FALSE, simulate.p.value = FALSE, B = 10000)

# rescale.p reescala p para que sume 1 (TRUE), si no, no es reescalado (FALSE)

chisq.test(x = tabla_prueba, correct = FALSE, rescale.p = TRUE, simulate.p.value = FALSE, B = 10000)

# "y" es similar a x, se pone la tabla a comparar, solo cambia con "x" y "y" factors del mismo tamaño

chisq.test(x = tabla_prueba, y = tabla_prueba, correct = FALSE, rescale.p = TRUE, simulate.p.value = FALSE, B = 10000)

# p es un vector de probabilidades del mismo tamaño que x, define el nivel de significancia de p

chisq.test(x = tabla_prueba, p = 0.05, correct = FALSE, simulate.p.value = FALSE, B = 10000)

```

Con el conocimiento de cada uno de los parámetros, se procede a realizar las pruebas para las tablas de contingencias creadas anteriormente

```{r Pruebas_independencia}

# Se inicia con las tablas con valores absolutos

chisq.test(x = tabla_1, correct = TRUE)

chisq.test(x = tabla_2, correct = TRUE)

chisq.test(x = tabla_3, correct = TRUE)

chisq.test(x = tabla_4, correct = TRUE)

chisq.test(x = tabla_5, correct = TRUE)

# Luego, se procede con las tablas que tienen porcentajes

chisq.test(x = tabla_1_prop, correct = TRUE)

chisq.test(x = tabla_2_prop, correct = TRUE)

chisq.test(x = tabla_3_prop, correct = TRUE)

chisq.test(x = tabla_4_prop, correct = TRUE)

chisq.test(x = tabla_5_prop, correct = TRUE)

```

